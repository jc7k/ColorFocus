<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://lh3.googleusercontent.com; connect-src 'self' https://*.supabase.co;">
  <title>ColorFocus - Stroop Puzzle</title>
  <link rel="stylesheet" href="styles/puzzle.css">
</head>
<body>
  <a href="#puzzleGrid" class="skip-link">Skip to puzzle</a>
  <h1 id="pageTitle">ColorFocus Stroop Puzzle</h1>
  <p class="subtitle" id="subtitle">Count the INK colors, not the word meanings!</p>

  <!-- Auth Section -->
  <div class="auth-section" id="authSection">
    <button id="loginBtn" class="auth-btn" data-i18n="signin_btn">Sign in with Google</button>
    <div id="userInfo" class="user-info" style="display: none;">
      <img id="userAvatar" class="user-avatar" alt="User avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 6v1h16v-1c0-3-2-6-8-6z'/%3E%3C/svg%3E">
      <span id="userName" class="user-name"></span>
      <button id="logoutBtn" class="auth-btn secondary" data-i18n="signout_btn">Sign out</button>
    </div>
  </div>

  <div class="controls">
    <div class="controls-main">
      <button id="generateBtn">Generate</button>
      <button id="randomBtn" class="secondary">Random</button>
    </div>
    <div class="controls-actions">
      <a href="https://buymeacoffee.com/xwje4mbv3l"
         target="_blank"
         rel="noopener noreferrer"
         class="donation-link"
         id="donationLink"
         data-i18n="support_link_text">Support</a>
      <button class="icon-btn" id="settingsBtn" aria-label="Open settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        <span class="icon-btn-text" id="settingsBtnText">Settings</span>
      </button>
      <button class="icon-btn" id="aboutBtn" aria-label="Help and About">
        <span style="font-size: 1.125rem; font-weight: 600;">?</span>
      </button>
    </div>
  </div>

  <!-- Hidden original controls for state management -->
  <div style="display: none;">
    <select id="difficulty">
      <option value="easy" selected>Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
      <option value="expert">Expert</option>
    </select>
    <select id="language">
      <option value="zh-TW" selected>Chinese</option>
      <option value="english">English</option>
      <option value="spanish">Spanish</option>
      <option value="vietnamese">Vietnamese</option>
    </select>
    <select id="spacing">
      <option value="compact">Compact</option>
      <option value="normal" selected>Normal</option>
      <option value="relaxed">Relaxed</option>
      <option value="spacious">Spacious</option>
    </select>
    <select id="gridSize">
      <option value="1">1x1</option>
      <option value="2">2x2</option>
      <option value="3">3x3</option>
      <option value="4" selected>4x4</option>
      <option value="5">5x5</option>
      <option value="6">6x6</option>
      <option value="7">7x7</option>
      <option value="8">8x8</option>
    </select>
    <select id="colorCount">
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4" selected>4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
    </select>
    <input type="number" id="congruence" value="75" min="0" max="100" step="0.1">
    <input type="number" id="seed" value="42" min="0">
    <input type="checkbox" id="soundToggle">
  </div>

  <div class="puzzle-container">
    <div class="puzzle-controls">
      <button id="clearSelectionsBtn" class="secondary" data-i18n="clear_selections_btn">Clear Selections</button>
    </div>
    <div class="puzzle-grid" id="puzzleGrid" role="grid" aria-label="Color puzzle grid"></div>
    <div class="metadata" id="metadata"></div>
  </div>

  <!-- Stroop Warning Panel (shown when tiles are assigned to wrong color) -->
  <div class="stroop-warning-panel" id="stroopWarningPanel">
    <div class="warning-icon">&#9888;</div>
    <div class="warning-content">
      <div class="warning-title" id="stroopWarningTitle">Stroop Interference Detected</div>
      <div class="warning-message" id="stroopWarningMessage"></div>
    </div>
    <button class="dismiss-btn" id="dismissWarningBtn">Got it</button>
  </div>

  <!-- Answer Submission Section -->
  <div class="answer-section">
    <h2 id="enterAnswersHeader">Enter Your Answers</h2>
    <div class="answer-grid" id="answerGrid"></div>
    <div class="answer-buttons">
      <button class="success" id="checkBtn">Check Answers</button>
      <button class="secondary" id="clearBtn">Clear</button>
    </div>
  </div>

  <!-- Results Section -->
  <div class="results-section" id="resultsSection">
    <h2 id="resultsHeader">Results</h2>
    <div class="results-summary" id="resultsSummary"></div>
    <div class="result-message" id="resultMessage"></div>
    <div class="results-buttons">
      <button class="secondary identify-mistakes-btn" id="identifyMistakesBtn">Identify Mistakes</button>
    </div>
  </div>

  <!-- Identification Mode Prompt -->
  <div class="identification-prompt" id="identificationPrompt">
    <div class="identification-prompt-header">
      <div class="identification-color-swatch" id="identificationColorSwatch"></div>
      <span class="identification-prompt-text" id="identificationPromptText">Select the tiles you thought were this color</span>
    </div>
    <div class="identification-next-indicator" id="identificationNextIndicator"></div>
    <div class="identification-buttons">
      <button class="success" id="identificationDoneBtn">Done</button>
      <button class="secondary" id="identificationCancelBtn">Cancel</button>
    </div>

  </div>

  <!-- Mistake Analysis Summary Panel -->
  <div class="mistake-summary-section" id="mistakeSummarySection">
    <h2 id="summaryHeader">Mistake Analysis Summary</h2>
    <div class="summary-stats" id="summaryStats">
      <div class="summary-stat">
        <div class="value error" id="totalMistakesValue">0</div>
        <div class="label" id="totalMistakesLabel">Total Mistakes</div>
      </div>
      <div class="summary-stat">
        <div class="value stroop" id="stroopInfluencedValue">0</div>
        <div class="label" id="stroopInfluencedLabel">Stroop-Influenced</div>
      </div>
      <div class="summary-stat">
        <div class="value" id="nonStroopValue">0</div>
        <div class="label" id="nonStroopLabel">Other Mistakes</div>
      </div>
    </div>
    <div class="mistake-legend" id="mistakeLegend">
      <h3 id="legendHeader">Legend</h3>
      <div class="legend-items">
        <div class="legend-item">
          <div class="legend-indicator correct" aria-hidden="true"></div>
          <span class="legend-text" id="legendCorrectText">Correctly identified</span>
        </div>
        <div class="legend-item">
          <div class="legend-indicator incorrect" aria-hidden="true"></div>
          <span class="legend-text" id="legendIncorrectText">Incorrectly identified</span>
        </div>
        <div class="legend-item">
          <div class="legend-indicator stroop" aria-hidden="true"></div>
          <span class="legend-text" id="legendStroopText">Stroop interference likely</span>
        </div>
      </div>
    </div>
    <!-- Stroop Guidance Section -->
    <div class="stroop-guidance-section" id="stroopGuidanceSection">
      <div class="guidance-subsection" id="guidanceEducation">
        <h4 id="guidanceEducationHeader">Understanding the Stroop Effect</h4>
        <p id="guidanceEducationText"></p>
      </div>
      <div class="guidance-subsection" id="guidancePattern">
        <h4 id="guidancePatternHeader">What Your Results Suggest</h4>
        <p id="guidancePatternText"></p>
      </div>
      <div class="guidance-subsection" id="guidanceTips">
        <h4 id="guidanceTipsHeader">Practice Tips</h4>
        <p id="guidanceTipsText"></p>
      </div>
    </div>
    <div class="summary-metadata" id="summaryMetadata">
      <div class="summary-metadata-grid">
        <div class="summary-metadata-item">
          <span class="label" id="metaSeedLabel">Seed:</span>
          <span class="value" id="metaSeedValue"></span>
        </div>
        <div class="summary-metadata-item">
          <span class="label" id="metaGridLabel">Grid:</span>
          <span class="value" id="metaGridValue"></span>
        </div>
        <div class="summary-metadata-item">
          <span class="label" id="metaLanguageLabel">Language:</span>
          <span class="value" id="metaLanguageValue"></span>
        </div>
        <div class="summary-metadata-item">
          <span class="label" id="metaDifficultyLabel">Difficulty:</span>
          <span class="value" id="metaDifficultyValue"></span>
        </div>
      </div>
    </div>
    <div class="summary-buttons">
      <button class="secondary" id="closeSummaryBtn">Close Analysis</button>
    </div>
  </div>


  <!-- Answer Key Section (Hidden by Default) -->
  <div class="answer-key-section">
    <h2>
      <span id="answerKeyHeader">Answer Key</span>
      <button class="secondary" id="revealBtn">Reveal</button>
    </h2>
    <div class="reveal-warning" id="revealWarning">
      Revealing the answer key will end your current attempt. Check your answers first!
    </div>
    <div class="answer-key-content" id="answerKeyContent">
      <div class="answer-key-grid" id="answerKeyGrid"></div>
    </div>
  </div>

  <!-- Donation QR Code Section -->
  <div class="donation-section">
    <a href="https://buymeacoffee.com/xwje4mbv3l" target="_blank" rel="noopener noreferrer">
      <img src="/frontend/bmc_qr.png" alt="QR code to support ColorFocus via Buy Me A Coffee" class="donation-qr">
    </a>
    <p class="donation-label" id="donationLabel" data-i18n="qr_code_label">Scan to support ColorFocus</p>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop" id="modalBackdrop"></div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" role="dialog" aria-labelledby="settingsModalTitle" aria-modal="true">
    <div class="modal-header">
      <h2 class="modal-title" id="settingsModalTitle">Settings</h2>
      <button class="modal-close" id="settingsModalClose" aria-label="Close settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <!-- Display Section -->
      <div class="modal-section">
        <div class="modal-section-title" id="settingsDisplayTitle">Display</div>
        <div class="settings-row">
          <label class="settings-label" for="modalLanguage" id="modalLanguageLabel">Language</label>
          <select id="modalLanguage" aria-label="Select display language">
            <option value="zh-TW">Chinese</option>
            <option value="english">English</option>
            <option value="spanish">Spanish</option>
            <option value="vietnamese">Vietnamese</option>
          </select>
        </div>
        <div class="settings-row">
          <label class="settings-label" for="modalSpacing" id="modalSpacingLabel">Spacing</label>
          <select id="modalSpacing" aria-label="Select grid spacing">
            <option value="compact">Compact</option>
            <option value="normal">Normal</option>
            <option value="relaxed">Relaxed</option>
            <option value="spacious">Spacious</option>
          </select>
        </div>
        <div class="settings-row">
          <span class="settings-label" id="modalSoundLabel">Selection Sound</span>
          <label class="toggle-switch">
            <input type="checkbox" id="modalSoundToggle" aria-label="Toggle selection sound">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- Puzzle Section -->
      <div class="modal-section">
        <div class="modal-section-title" id="settingsPuzzleTitle">Puzzle</div>
        <div class="settings-row">
          <label class="settings-label" for="modalDifficulty" id="modalDifficultyLabel">Difficulty</label>
          <select id="modalDifficulty" aria-label="Select difficulty level">
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
            <option value="expert">Expert</option>
          </select>
        </div>
        <div class="settings-row" id="modalGridSizeGroup">
          <label class="settings-label" for="modalGridSize" id="modalGridLabel">Grid Size</label>
          <select id="modalGridSize" aria-label="Select grid size">
            <option value="1">1x1</option>
            <option value="2">2x2</option>
            <option value="3">3x3</option>
            <option value="4">4x4</option>
            <option value="5">5x5</option>
            <option value="6">6x6</option>
            <option value="7">7x7</option>
            <option value="8">8x8</option>
          </select>
        </div>
        <div class="settings-row" id="modalColorCountGroup">
          <label class="settings-label" for="modalColorCount" id="modalColorsLabel">Colors</label>
          <select id="modalColorCount">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
          </select>
        </div>
        <!-- Match % is now controlled by difficulty and hidden from UI -->
        <input type="hidden" id="modalCongruence" value="75">
        <div class="settings-row">
          <label class="settings-label" for="modalSeed" id="modalSeedLabel">Seed</label>
          <input type="number" id="modalSeed" value="42" min="0">
        </div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal" id="aboutModal" role="dialog" aria-labelledby="aboutModalTitle" aria-modal="true">
    <div class="modal-header">
      <h2 class="modal-title" id="aboutModalTitle">About</h2>
      <button class="modal-close" id="aboutModalClose" aria-label="Close about">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="about-header">
        <div class="about-icon">CF</div>
        <p class="about-tagline" id="aboutTagline">Cognitive training through Stroop interference puzzles</p>
      </div>

      <div class="about-section">
        <h3 class="about-section-title" id="aboutHowToPlayTitle">How to Play</h3>
        <p class="about-text" id="aboutHowToPlayText">Count how many cells are printed in each INK color. The word shows a color name, but you must count the actual ink color used to display it. Tip: Click tiles to select them, then click the color swatch in Enter Your Answers to auto-fill the count. Use Clear Selections to deselect all.</p>
      </div>

      <div class="about-section">
        <h3 class="about-section-title" id="aboutWhatTitle">What is ColorFocus?</h3>
        <p class="about-text" id="aboutWhatText">ColorFocus uses the Stroop effect to exercise your brain. When you see a color word printed in a different ink color, your brain must resolve the conflict between reading the word and identifying the ink color. This cognitive challenge helps strengthen attention and processing speed.</p>
      </div>

      <div class="about-section">
        <h3 class="about-section-title" id="aboutStoryTitle">Our Story</h3>
        <div class="about-story" id="aboutStoryText">
          This app was inspired by my mother, who suffered a minor stroke days before Thanksgiving 2025. After initial recovery, she passed all hospital tests, but we wanted to check for subtle cognitive changes. Remembering the Stroop Test from my college Perception and Cognition course, I created a 9x9 puzzle with colored Chinese words (her native language) to test if her language and perception centers were affected.
          <br><br>
          She immediately had difficulty with two adjacent tiles showing incongruent red/green characters. After explaining the Stroop effect and how it detects task interference, she used the puzzles for mental exercise. The next day, the effect was reduced—and soon disappeared entirely.
          <br><br>
          I built this app hoping other stroke survivors can identify similar challenges and rehabilitate the way my mom did. Even if you're not recovering from a stroke, this can be a fun cognitive exercise. I'd love to hear your story—please reach out!
        </div>
      </div>

      <div class="about-footer">
        <a href="https://buymeacoffee.com/xwje4mbv3l" target="_blank" rel="noopener noreferrer" class="about-link" id="aboutSupportLink">Support ColorFocus</a>
      </div>
    </div>
  </div>


  <script type="module" src="src/modules/index.js"></script>
</body>
</html>
